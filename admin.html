<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Urbana Visión</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #1e293b; 
            min-height: 100vh; 
            color: white; 
            padding: 15px; 
        }
        .container { max-width: 420px; margin: 0 auto; }
        
        .header { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 20px; 
            padding: 25px; 
            text-align: center; 
            margin-bottom: 25px; 
        }
        .logo { 
            width: 55px; 
            height: 55px; 
            background: #3b82f6; 
            border-radius: 50%; 
            margin: 0 auto 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
        }
        h1 { font-size: 22px; margin-bottom: 8px; }
        .subtitle { font-size: 13px; opacity: 0.8; }

        .analytics-dashboard { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 20px; 
            padding: 25px; 
            margin-bottom: 20px; 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 12px; 
            padding: 15px; 
            text-align: center; 
        }
        .stat-number { 
            font-size: 24px; 
            font-weight: 700; 
            color: #10b981; 
            margin-bottom: 5px; 
        }
        .stat-label { 
            font-size: 12px; 
            color: #94a3b8; 
        }

        .main-card { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 20px; 
            padding: 25px; 
            margin-bottom: 20px; 
        }
        .section-title { 
            font-size: 16px; 
            color: #60a5fa; 
            margin-bottom: 20px; 
            text-align: center; 
            font-weight: 600;
        }

        .photo-upload-area { 
            border: 2px dashed #60a5fa; 
            border-radius: 15px; 
            padding: 30px; 
            text-align: center; 
            margin-bottom: 20px; 
            cursor: pointer; 
            background: rgba(59, 130, 246, 0.05); 
        }
        .photo-upload-area.has-photo { 
            border-color: #10b981; 
            background: rgba(16, 185, 129, 0.1); 
        }
        .photo-preview { 
            width: 200px; 
            height: 200px; 
            border-radius: 12px; 
            margin: 0 auto 15px; 
            object-fit: cover; 
            display: none; 
        }
        .upload-text { color: #60a5fa; font-size: 14px; }

        .form-grid { display: grid; gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { 
            font-size: 13px; 
            color: #cbd5e1; 
            margin-bottom: 8px; 
            font-weight: 600;
        }
        .form-input, .form-select { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 10px; 
            padding: 12px 15px; 
            color: white; 
            font-size: 14px; 
        }
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: #60a5fa; 
            background: rgba(255, 255, 255, 0.15); 
        }
        .form-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .form-select option { background: #334155; color: white; }

        .btn { 
            background: #10b981; 
            border: none; 
            border-radius: 12px; 
            padding: 15px; 
            color: white; 
            font-size: 15px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            margin-bottom: 15px; 
        }
        .btn:disabled { background: #64748b; cursor: not-allowed; }
        .btn-secondary { background: #6366f1; }
        .btn-info { background: #06b6d4; }

        .success-message { 
            background: #10b981; 
            padding: 15px; 
            border-radius: 12px; 
            text-align: center; 
            margin-bottom: 20px; 
            display: none; 
        }
        .error-message { 
            background: rgba(239, 68, 68, 0.8); 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            display: none; 
        }

        .result-card { 
            background: rgba(59, 130, 246, 0.1); 
            border: 1px solid rgba(59, 130, 246, 0.3); 
            border-radius: 15px; 
            padding: 20px; 
            margin-top: 20px; 
            display: none; 
        }
        .result-title { 
            color: #60a5fa; 
            font-size: 14px; 
            margin-bottom: 15px; 
            font-weight: 600;
        }
        .link-display { 
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 8px; 
            padding: 12px; 
            font-family: monospace; 
            font-size: 11px; 
            color: #e2e8f0; 
            word-break: break-all; 
            margin-bottom: 15px; 
        }
        .message-preview { 
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 8px; 
            padding: 15px; 
            font-size: 12px; 
            white-space: pre-wrap; 
            margin-bottom: 15px; 
        }
        .copy-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        .copy-btn { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 8px; 
            padding: 10px; 
            color: white; 
            font-size: 12px; 
            cursor: pointer; 
        }

        .catalog-section { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 20px; 
            padding: 25px; 
        }
        .catalog-list { 
            max-height: 350px; 
            overflow-y: auto; 
            margin-top: 15px; 
        }
        .catalog-item { 
            background: rgba(255, 255, 255, 0.05); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .item-info { flex: 1; }
        .item-code { 
            font-weight: 600; 
            color: #60a5fa; 
            margin-bottom: 5px; 
        }
        .item-details { 
            font-size: 12px; 
            color: #94a3b8; 
        }
        .item-actions { display: flex; gap: 8px; }
        .action-btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 6px; 
            font-size: 11px; 
            cursor: pointer; 
            color: white; 
            font-weight: 600;
            text-decoration: none;
        }
        .btn-view { background: #3b82f6; }
        .btn-delete { background: #ef4444; }

        .empty-catalog { 
            text-align: center; 
            padding: 40px 20px; 
            color: #64748b; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">👓</div>
            <h1>Panel Administrativo</h1>
            <p class="subtitle">Urbana Visión - Gestión de Catálogo</p>
        </div>

        <div class="analytics-dashboard">
            <div class="section-title">📊 Analytics Dashboard</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalViews">0</div>
                    <div class="stat-label">Vistas Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="whatsappClicks">0</div>
                    <div class="stat-label">Clics WhatsApp</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conversionRate">0%</div>
                    <div class="stat-label">Tasa Conversión</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMonturas">0</div>
                    <div class="stat-label">Total Monturas</div>
                </div>
            </div>
            <button class="btn btn-info" onclick="showReport()">📈 Ver Reporte</button>
        </div>

        <div class="main-card">
            <div class="section-title">📸 Agregar Nueva Montura</div>

            <div id="successMsg" class="success-message">✅ Montura agregada exitosamente</div>
            <div id="errorMsg" class="error-message"></div>

            <div class="photo-upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                <img id="photoPreview" class="photo-preview">
                <div id="uploadText" class="upload-text">
                    <div style="font-size: 32px; margin-bottom: 10px;">📷</div>
                    <div><strong>Toca para tomar foto</strong></div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Imagen optimizada automáticamente</div>
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Código de Montura</label>
                    <input type="text" id="codigoInput" class="form-input" placeholder="Ej: H001, M150, D025, N003" maxlength="4">
                </div>

                <div class="form-group">
                    <label class="form-label">Categoría</label>
                    <select id="categoriaSelect" class="form-select">
                        <option value="">Seleccionar categoría</option>
                        <option value="hombre">👨 Hombres</option>
                        <option value="mujer">👩 Mujeres</option>
                        <option value="deportivo">🏃 Deportivos</option>
                        <option value="niños">👶 Niños</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Precio</label>
                    <input type="text" id="precioInput" class="form-input" placeholder="Ej: $2,500, RD$3,200" maxlength="15">
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre/Descripción (Opcional)</label>
                    <input type="text" id="nombreInput" class="form-input" placeholder="Ej: Ray-Ban Aviador Negro" maxlength="50">
                </div>
            </div>

            <button id="saveBtn" class="btn" onclick="saveMontura()">💾 Guardar en Catálogo</button>
            <button class="btn btn-secondary" onclick="openCatalog()">👁️ Ver Catálogo Cliente</button>

            <div id="resultCard" class="result-card">
                <div class="result-title">📱 Enlace generado para WhatsApp</div>
                <div><strong>Enlace directo:</strong></div>
                <div id="generatedLink" class="link-display"></div>
                <div><strong>Mensaje para copiar:</strong></div>
                <div id="whatsappMessage" class="message-preview"></div>
                <div class="copy-buttons">
                    <button class="copy-btn" onclick="copyLink()">📋 Copiar Enlace</button>
                    <button class="copy-btn" onclick="copyMessage()">💬 Copiar Mensaje</button>
                </div>
            </div>
        </div>

        <div class="catalog-section">
            <div class="section-title">📋 Monturas en Catálogo</div>
            <div id="catalogList" class="catalog-list">
                <div class="empty-catalog">
                    <div style="font-size: 48px; margin-bottom: 15px;">📦</div>
                    <div>No hay monturas en el catálogo</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var ADMIN_WHATSAPP = '18097135307';
        var ADMIN_BASE_URL = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
        var ADMIN_SELECTED_PHOTO = null;
        var ADMIN_CURRENT_LINK = '';
        var ADMIN_CURRENT_MESSAGE = '';

        function checkAdminAccess() {
            var password = prompt('🔐 Contraseña de administrador:');
            if (password !== 'urbana2025') {
                alert('❌ Acceso denegado');
                window.location.href = ADMIN_BASE_URL;
                return false;
            }
            return true;
        }

        function adminGetData() {
            try {
                var data = localStorage.getItem('urbana_monturas');
                if (data && data !== 'null' && data !== 'undefined') {
                    return JSON.parse(data);
                }
            } catch (e) {}
            return {};
        }

        function adminSetData(data) {
            try {
                localStorage.setItem('urbana_monturas', JSON.stringify(data));
                return true;
            } catch (e) {
                return false;
            }
        }

        function getAdminViews() {
            try {
                var views = localStorage.getItem('urbana_views');
                return views ? parseInt(views) : 0;
            } catch (e) {
                return 0;
            }
        }

        function getAdminWhatsApp() {
            try {
                var clicks = localStorage.getItem('urbana_whatsapp');
                return clicks ? parseInt(clicks) : 0;
            } catch (e) {
                return 0;
            }
        }

        function updateAdminDashboard() {
            var views = getAdminViews();
            var whatsapp = getAdminWhatsApp();
            var monturas = Object.keys(adminGetData()).length;
            var conversion = views > 0 ? ((whatsapp / views) * 100).toFixed(1) : 0;

            var totalViewsElement = document.getElementById('totalViews');
            var whatsappClicksElement = document.getElementById('whatsappClicks');
            var conversionRateElement = document.getElementById('conversionRate');
            var totalMonturasElement = document.getElementById('totalMonturas');

            if (totalViewsElement) totalViewsElement.textContent = views;
            if (whatsappClicksElement) whatsappClicksElement.textContent = whatsapp;
            if (conversionRateElement) conversionRateElement.textContent = conversion + '%';
            if (totalMonturasElement) totalMonturasElement.textContent = monturas;
        }

        document.getElementById('photoInput').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                compressAdminImage(file);
            }
        });

        function compressAdminImage(file) {
            try {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var img = new Image();
                
                img.onload = function() {
                    var maxSize = 800;
                    var width = img.width;
                    var height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    ADMIN_SELECTED_PHOTO = canvas.toDataURL('image/jpeg', 0.7);
                    showAdminPreview();
                };
                
                img.onerror = function() {
                    showAdminError('Error procesando imagen');
                };
                
                img.src = URL.createObjectURL(file);
            } catch (e) {
                showAdminError('Error procesando imagen');
            }
        }

        function showAdminPreview() {
            var area = document.getElementById('uploadArea');
            var preview = document.getElementById('photoPreview');
            var text = document.getElementById('uploadText');
            
            if (preview && text && area) {
                preview.src = ADMIN_SELECTED_PHOTO;
                preview.style.display = 'block';
                text.innerHTML = '<div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;">✅ Foto lista</div>';
                area.className = 'photo-upload-area has-photo';
            }
        }

        function showAdminError(message) {
            var error = document.getElementById('errorMsg');
            if (error) {
                error.innerHTML = '❌ ' + message;
                error.style.display = 'block';
                setTimeout(function() {
                    error.style.display = 'none';
                }, 3000);
            }
        }

        function saveMontura() {
            var codigo = document.getElementById('codigoInput').value.trim().toUpperCase();
            var categoria = document.getElementById('categoriaSelect').value;
            var precio = document.getElementById('precioInput').value.trim();
            var nombre = document.getElementById('nombreInput').value.trim();

            if (!ADMIN_SELECTED_PHOTO) {
                showAdminError('Toma una foto de la montura');
                return;
            }
            if (!codigo || codigo.length < 3) {
                showAdminError('Ingresa un código válido');
                return;
            }
            if (!categoria) {
                showAdminError('Selecciona una categoría');
                return;
            }
            if (!precio) {
                showAdminError('Ingresa el precio');
                return;
            }

            var data = adminGetData();
            if (data[codigo]) {
                showAdminError('Código ' + codigo + ' ya existe');
                return;
            }

            document.getElementById('saveBtn').disabled = true;
            
            var montura = {
                codigo: codigo,
                categoria: categoria,
                precio: precio,
                nombre: nombre || 'Sin nombre',
                foto: ADMIN_SELECTED_PHOTO,
                fechaCreacion: new Date().toISOString()
            };
            
            data[codigo] = montura;
            
            if (adminSetData(data)) {
                generateAdminWhatsAppLink(montura);
                
                var success = document.getElementById('successMsg');
                if (success) {
                    success.style.display = 'block';
                    setTimeout(function() {
                        success.style.display = 'none';
                    }, 3000);
                }
                
                var result = document.getElementById('resultCard');
                if (result) {
                    result.style.display = 'block';
                }
                
                clearAdminForm();
                loadAdminCatalog();
                updateAdminDashboard();
            } else {
                showAdminError('Error guardando montura');
            }
            
            document.getElementById('saveBtn').disabled = false;
        }

        function generateAdminWhatsAppLink(montura) {
            ADMIN_CURRENT_LINK = ADMIN_BASE_URL + '?codigo=' + montura.codigo;
            
            var categories = {
                'hombre': '👨 Hombres',
                'mujer': '👩 Mujeres',
                'deportivo': '🏃 Deportivos',
                'niños': '👶 Niños'
            };
            
            ADMIN_CURRENT_MESSAGE = '🥽 *NUEVA MONTURA - Urbana Visión*\n\n' +
                '📋 *Código:* ' + montura.codigo + '\n' +
                '👤 *Categoría:* ' + categories[montura.categoria] + '\n' +
                '💰 *Precio:* ' + montura.precio + '\n' +
                (montura.nombre !== 'Sin nombre' ? '📝 *Modelo:* ' + montura.nombre + '\n' : '') +
                '\n📱 *VER FOTO COMPLETA:*\n' + ADMIN_CURRENT_LINK +
                '\n\n🏥 *Urbana Visión*\n📱 WhatsApp: 809-713-5307\n🎁 6 meses de garantía\n\n_Toca el enlace para ver la foto_ 👆';
            
            var linkElement = document.getElementById('generatedLink');
            var messageElement = document.getElementById('whatsappMessage');
            
            if (linkElement) linkElement.textContent = ADMIN_CURRENT_LINK;
            if (messageElement) messageElement.textContent = ADMIN_CURRENT_MESSAGE;
        }

        function copyLink() {
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(ADMIN_CURRENT_LINK).then(function() {
                        alert('📋 Enlace copiado');
                    });
                } else {
                    var textarea = document.createElement('textarea');
                    textarea.value = ADMIN_CURRENT_LINK;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('📋 Enlace copiado');
                }
            } catch (e) {
                alert('Error copiando enlace');
            }
        }

        function copyMessage() {
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(ADMIN_CURRENT_MESSAGE).then(function() {
                        alert('💬 Mensaje copiado');
                    });
                } else {
                    var textarea = document.createElement('textarea');
                    textarea.value = ADMIN_CURRENT_MESSAGE;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('💬 Mensaje copiado');
                }
            } catch (e) {
                alert('Error copiando mensaje');
            }
        }

        function clearAdminForm() {
            var inputs = ['codigoInput', 'categoriaSelect', 'precioInput', 'nombreInput'];
            for (var i = 0; i < inputs.length; i++) {
                var element = document.getElementById(inputs[i]);
                if (element) {
                    element.value = '';
                }
            }
            
            ADMIN_SELECTED_PHOTO = null;
            
            var preview = document.getElementById('photoPreview');
            var area = document.getElementById('uploadArea');
            var text = document.getElementById('uploadText');
            
            if (preview) preview.style.display = 'none';
            if (area) area.className = 'photo-upload-area';
            if (text) {
                text.innerHTML = '<div style="font-size: 32px; margin-bottom: 10px;">📷</div><div><strong>Toca para tomar foto</strong></div><div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Imagen optimizada automáticamente</div>';
            }
        }

        function loadAdminCatalog() {
            var list = document.getElementById('catalogList');
            var data = adminGetData();
            var items = Object.values(data);
            
            if (items.length === 0) {
                list.innerHTML = '<div class="empty-catalog"><div style="font-size: 48px; margin-bottom: 15px;">📦</div><div>No hay monturas en el catálogo</div></div>';
                return;
            }
            
            items.sort(function(a, b) {
                return new Date(b.fechaCreacion) - new Date(a.fechaCreacion);
            });
            
            var html = '';
            for (var i = 0; i < items.length; i++) {
                var montura = items[i];
                var icons = { 'hombre': '👨', 'mujer': '👩', 'deportivo': '🏃', 'niños': '👶' };
                var icon = icons[montura.categoria] || '👓';
                var link = ADMIN_BASE_URL + '?codigo=' + montura.codigo;
                var date = new Date(montura.fechaCreacion).toLocaleDateString();
                
                html += '<div class="catalog-item">';
                html += '<div class="item-info">';
                html += '<div class="item-code">' + icon + ' ' + montura.codigo + ' - ' + montura.precio + '</div>';
                html += '<div class="item-details">' + montura.nombre + ' | ' + date + '</div>';
                html += '</div>';
                html += '<div class="item-actions">';
                html += '<a href="' + link + '" target="_blank" class="action-btn btn-view">Ver</a>';
                html += '<button onclick="deleteAdminMontura(\'' + montura.codigo + '\')" class="action-btn btn-delete">❌</button>';
                html += '</div>';
                html += '</div>';
            }
            
            list.innerHTML = html;
        }

        function deleteAdminMontura(codigo) {
            if (confirm('¿Eliminar montura ' + codigo + '?')) {
                var data = adminGetData();
                delete data[codigo];
                if (adminSetData(data)) {
                    loadAdminCatalog();
                    updateAdminDashboard();
                    alert('✅ Montura eliminada');
                }
            }
        }

        function showReport() {
            var views = getAdminViews();
            var whatsapp = getAdminWhatsApp();
            var monturas = Object.keys(adminGetData()).length;
            var conversion = views > 0 ? ((whatsapp / views) * 100).toFixed(1) : 0;
            
            alert('📊 REPORTE URBANA VISIÓN\n\n📈 RESUMEN:\n• Total Vistas: ' + views + '\n• Clics WhatsApp: ' + whatsapp + '\n• Conversión: ' + conversion + '%\n• Monturas: ' + monturas + '\n\n💡 RENDIMIENTO:\n' + (conversion > 10 ? '✅ Excelente conversión' : conversion > 5 ? '⚠️ Conversión moderada' : '❌ Mejorar estrategia'));
        }

        function openCatalog() {
            window.open(ADMIN_BASE_URL, '_blank');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (checkAdminAccess()) {
                    loadAdminCatalog();
                    updateAdminDashboard();
                }
            });
        } else {
            if (checkAdminAccess()) {
                loadAdminCatalog();
                updateAdminDashboard();
            }
        }
    </script>
</body>
</html>
