<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Urbana Visi√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); min-height: 100vh; color: white; padding: 15px; }
        .container { max-width: 420px; margin: 0 auto; }
        .header { background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 25px; text-align: center; margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .logo { width: 55px; height: 55px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        h1 { font-size: 22px; margin-bottom: 8px; }
        .subtitle { font-size: 13px; opacity: 0.8; }
        .main-card { background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .section-title { font-size: 16px; color: #60a5fa; margin-bottom: 20px; text-align: center; }
        .photo-upload-area { border: 2px dashed #60a5fa; border-radius: 15px; padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; background: rgba(59, 130, 246, 0.05); }
        .photo-upload-area:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .photo-upload-area.has-photo { border-style: solid; border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .photo-preview { width: 200px; height: 200px; border-radius: 12px; margin: 0 auto 15px; object-fit: cover; display: none; border: 2px solid rgba(255, 255, 255, 0.2); }
        .upload-text { color: #60a5fa; font-size: 14px; }
        .form-grid { display: grid; gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-size: 13px; color: #cbd5e1; margin-bottom: 8px; }
        .form-input, .form-select { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 12px 15px; color: white; font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #60a5fa; background: rgba(255, 255, 255, 0.15); }
        .form-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .form-select option { background: #334155; color: white; }
        .codigo-info { font-size: 11px; color: #94a3b8; margin-top: 5px; }
        .btn { background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 12px; padding: 15px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 15px; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { background: #64748b; cursor: not-allowed; transform: none; }
        .btn-secondary { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .success-message { background: linear-gradient(135deg, #10b981, #059669); padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; display: none; }
        .result-card { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 15px; padding: 20px; margin-top: 20px; display: none; }
        .result-title { color: #60a5fa; font-size: 14px; margin-bottom: 15px; }
        .link-display { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 11px; color: #e2e8f0; word-break: break-all; margin-bottom: 15px; }
        .message-preview { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; font-size: 12px; white-space: pre-wrap; margin-bottom: 15px; }
        .copy-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .copy-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 10px; color: white; font-size: 12px; cursor: pointer; }
        .copy-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .catalog-section { background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 25px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .catalog-list { max-height: 350px; overflow-y: auto; margin-top: 15px; }
        .catalog-item { background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .item-info { flex: 1; }
        .item-code { font-weight: 600; color: #60a5fa; margin-bottom: 5px; }
        .item-details { font-size: 12px; color: #94a3b8; }
        .item-actions { display: flex; gap: 8px; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; text-decoration: none; color: white; }
        .btn-view { background: #3b82f6; }
        .btn-delete { background: #ef4444; }
        .upload-progress { background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; border-radius: 10px; padding: 15px; text-align: center; margin: 15px 0; display: none; }
        .progress-text { color: #60a5fa; font-size: 13px; }
        .empty-catalog { text-align: center; padding: 40px 20px; color: #64748b; }
        .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #fca5a5; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üëì</div>
            <h1>Panel Administrativo</h1>
            <p class="subtitle">Urbana Visi√≥n - Gesti√≥n de Cat√°logo</p>
        </div>

        <div class="main-card">
            <div class="section-title">üì∏ Agregar Nueva Montura</div>

            <div id="successMsg" class="success-message">‚úÖ Montura agregada exitosamente</div>
            <div id="errorMsg" class="error-message"></div>
            <div id="uploadProgress" class="upload-progress"><div class="progress-text">üîÑ Subiendo imagen...</div></div>

            <div class="photo-upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click()">
                <img id="photoPreview" class="photo-preview">
                <div id="uploadText" class="upload-text">
                    <div style="font-size: 32px; margin-bottom: 10px;">üì∑</div>
                    <div><strong>Toca para tomar foto</strong></div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">La imagen se optimizar√° autom√°ticamente</div>
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">C√≥digo de Montura</label>
                    <input type="text" id="codigoInput" class="form-input" placeholder="Ej: H001, M150, D025, N003" maxlength="4">
                    <div class="codigo-info">H001-H999 (Hombres), M001-M999 (Mujeres), D001-D999 (Deportivos), N001-N999 (Ni√±os)</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select id="categoriaSelect" class="form-select">
                        <option value="">Seleccionar categor√≠a</option>
                        <option value="hombre">üë® Hombres</option>
                        <option value="mujer">üë© Mujeres</option>
                        <option value="deportivo">üèÉ Deportivos</option>
                        <option value="ni√±os">üë∂ Ni√±os</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Precio</label>
                    <input type="text" id="precioInput" class="form-input" placeholder="Ej: $2,500, RD$3,200" maxlength="15">
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre/Descripci√≥n (Opcional)</label>
                    <input type="text" id="nombreInput" class="form-input" placeholder="Ej: Ray-Ban Aviador Negro" maxlength="50">
                </div>
            </div>

            <button id="saveBtn" class="btn" onclick="guardarMontura()">üíæ Guardar en Cat√°logo</button>
            <button class="btn btn-secondary" onclick="verCatalogo()">üëÅÔ∏è Ver Cat√°logo Cliente</button>

            <div id="resultCard" class="result-card">
                <div class="result-title">üì± Enlace generado para WhatsApp</div>
                <div><strong>Enlace directo:</strong></div>
                <div id="generatedLink" class="link-display"></div>
                <div><strong>Mensaje para copiar:</strong></div>
                <div id="whatsappMessage" class="message-preview"></div>
                <div class="copy-buttons">
                    <button class="copy-btn" onclick="copiarEnlace()">üìã Copiar Enlace</button>
                    <button class="copy-btn" onclick="copiarMensaje()">üí¨ Copiar Mensaje</button>
                </div>
            </div>
        </div>

        <div class="catalog-section">
            <div class="section-title">üìã Monturas en Cat√°logo</div>
            <div id="catalogList" class="catalog-list">
                <div class="empty-catalog">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
                    <div>No hay monturas en el cat√°logo</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_CONFIG = {
            username: 'urbana419',
            repo: 'catalogo-urbana',
            token: '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',
            branch: 'main'
        };

        let selectedPhoto = null;
        let currentLink = '';
        let currentMessage = '';

        // Obtener monturas desde GitHub y localStorage como backup
        async function obtenerMonturas() {
            try {
                // Intentar desde GitHub primero
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/catalogo.json?t=${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    // Guardar backup en localStorage
                    localStorage.setItem('monturas', JSON.stringify(data));
                    return data;
                }
            } catch (error) {
                console.log('Error GitHub, usando backup:', error);
            }
            
            // Usar localStorage como backup
            try {
                const data = localStorage.getItem('monturas');
                return data ? JSON.parse(data) : {};
            } catch (error) {
                console.log('Error localStorage:', error);
                return {};
            }
        }

        // Guardar monturas en GitHub Y localStorage
        async function guardarMonturas(monturas) {
            try {
                // Guardar en localStorage como backup inmediato
                localStorage.setItem('monturas', JSON.stringify(monturas));
                
                // Subir archivo JSON a GitHub
                const catalogoJson = JSON.stringify(monturas, null, 2);
                const base64Content = btoa(unescape(encodeURIComponent(catalogoJson)));
                
                // Primero verificar si existe el archivo
                let sha = null;
                try {
                    const existingFile = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/catalogo.json`, {
                        headers: { 'Authorization': `token ${GITHUB_CONFIG.token}` }
                    });
                    if (existingFile.ok) {
                        const fileData = await existingFile.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    console.log('Archivo no existe, creando nuevo');
                }
                
                // Subir/actualizar archivo
                const body = {
                    message: 'Update catalog',
                    content: base64Content,
                    branch: GITHUB_CONFIG.branch
                };
                if (sha) body.sha = sha;
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/catalogo.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                return response.ok;
                
            } catch (error) {
                console.log('Error guardando en GitHub:', error);
                // Al menos tenemos el backup local
                return true;
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await cargarCatalogo();
        });

        document.getElementById('photoInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    selectedPhoto = await comprimirImagen(file);
                    mostrarPreview();
                } catch (error) {
                    mostrarError('Error procesando imagen');
                }
            }
        });

        function comprimirImagen(file, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    const maxSize = 800;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function mostrarPreview() {
            const uploadArea = document.getElementById('uploadArea');
            const preview = document.getElementById('photoPreview');
            const uploadText = document.getElementById('uploadText');
            
            preview.src = selectedPhoto;
            preview.style.display = 'block';
            uploadText.innerHTML = '<div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;">‚úÖ Foto lista</div>';
            uploadArea.classList.add('has-photo');
        }

        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = `‚ùå ${mensaje}`;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        async function subirImagenGitHub(imageData, filename) {
            const base64Data = imageData.split(',')[1];
            
            const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/images/${filename}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Add ${filename}`,
                    content: base64Data,
                    branch: GITHUB_CONFIG.branch
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                if (response.status === 409) {
                    // Archivo ya existe, est√° bien
                    return `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/images/${filename}`;
                }
                throw new Error(`GitHub Error ${response.status}: ${errorData.message || 'Error desconocido'}`);
            }
            
            return `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/images/${filename}`;
        }

        async function guardarMontura() {
            const codigo = document.getElementById('codigoInput').value.trim().toUpperCase();
            const categoria = document.getElementById('categoriaSelect').value;
            const precio = document.getElementById('precioInput').value.trim();
            const nombre = document.getElementById('nombreInput').value.trim();

            if (!selectedPhoto) {
                mostrarError('Toma una foto de la montura');
                return;
            }
            if (!codigo) {
                mostrarError('Ingresa un c√≥digo v√°lido');
                return;
            }
            if (!categoria) {
                mostrarError('Selecciona una categor√≠a');
                return;
            }
            if (!precio) {
                mostrarError('Ingresa el precio');
                return;
            }

            const monturas = await obtenerMonturas();
            if (monturas[codigo]) {
                mostrarError(`C√≥digo ${codigo} ya existe. Usa otro c√≥digo.`);
                return;
            }

            try {
                document.getElementById('uploadProgress').style.display = 'block';
                document.getElementById('saveBtn').disabled = true;
                
                const filename = `${codigo.toLowerCase()}.jpg`;
                const imageUrl = await subirImagenGitHub(selectedPhoto, filename);
                
                const nuevaMontura = {
                    codigo: codigo,
                    categoria: categoria,
                    precio: precio,
                    nombre: nombre || 'Sin nombre',
                    foto: imageUrl,
                    fechaCreacion: new Date().toISOString()
                };
                
                monturas[codigo] = nuevaMontura;
                await guardarMonturas(monturas);
                
                generarEnlaceWhatsApp(nuevaMontura);
                
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('successMsg').style.display = 'block';
                document.getElementById('resultCard').style.display = 'block';
                
                limpiarFormulario();
                await cargarCatalogo();
                
                setTimeout(() => {
                    document.getElementById('successMsg').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                document.getElementById('uploadProgress').style.display = 'none';
                mostrarError(error.message);
            } finally {
                document.getElementById('saveBtn').disabled = false;
            }
        }

        function generarEnlaceWhatsApp(montura) {
            // URL m√°s robusta que funciona con cualquier estructura
            const currentUrl = new URL(window.location.href);
            const baseUrl = `${currentUrl.protocol}//${currentUrl.host}${currentUrl.pathname.replace(/\/[^\/]*$/, '')}`;
            currentLink = `${baseUrl}/?codigo=${montura.codigo}`;
            
            const nombreCategoria = {
                'hombre': 'üë® Hombres',
                'mujer': 'üë© Mujeres',
                'deportivo': 'üèÉ Deportivos',
                'ni√±os': 'üë∂ Ni√±os'
            }[montura.categoria];
            
            currentMessage = `ü•Ω *NUEVA MONTURA - Urbana Visi√≥n*

üìã *C√≥digo:* ${montura.codigo}
üë§ *Categor√≠a:* ${nombreCategoria}
üí∞ *Precio:* ${montura.precio}
${montura.nombre !== 'Sin nombre' ? `üìù *Modelo:* ${montura.nombre}` : ''}

üì± *VER FOTO COMPLETA:*
${currentLink}

üè• *Urbana Visi√≥n*
üì± WhatsApp: 809-713-5307
üéÅ 6 meses de garant√≠a

_Toca el enlace para ver la foto_ üëÜ`;
            
            document.getElementById('generatedLink').textContent = currentLink;
            document.getElementById('whatsappMessage').textContent = currentMessage;
        }

        function copiarEnlace() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(currentLink).then(() => {
                    alert('üìã Enlace copiado');
                });
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = currentLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('üìã Enlace copiado');
            }
        }

        function copiarMensaje() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(currentMessage).then(() => {
                    alert('üí¨ Mensaje copiado');
                });
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = currentMessage;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('üí¨ Mensaje copiado');
            }
        }

        function limpiarFormulario() {
            document.getElementById('codigoInput').value = '';
            document.getElementById('categoriaSelect').value = '';
            document.getElementById('precioInput').value = '';
            document.getElementById('nombreInput').value = '';
            
            selectedPhoto = null;
            const uploadArea = document.getElementById('uploadArea');
            const preview = document.getElementById('photoPreview');
            const uploadText = document.getElementById('uploadText');
            
            preview.style.display = 'none';
            uploadArea.classList.remove('has-photo');
            uploadText.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 10px;">üì∑</div>
                <div><strong>Toca para tomar foto</strong></div>
                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">La imagen se optimizar√° autom√°ticamente</div>
            `;
        }

        async function cargarCatalogo() {
            const catalogList = document.getElementById('catalogList');
            const monturas = await obtenerMonturas();
            const monturasArray = Object.values(monturas);
            
            if (monturasArray.length === 0) {
                catalogList.innerHTML = `
                    <div class="empty-catalog">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
                        <div>No hay monturas en el cat√°logo</div>
                    </div>
                `;
                return;
            }
            
            monturasArray.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            
            let html = '';
            monturasArray.forEach(montura => {
                const iconoCategoria = {
                    'hombre': 'üë®',
                    'mujer': 'üë©',
                    'deportivo': 'üèÉ',
                    'ni√±os': 'üë∂'
                }[montura.categoria] || 'üëì';
                
                // URL m√°s robusta
                const currentUrl = new URL(window.location.href);
                const baseUrl = `${currentUrl.protocol}//${currentUrl.host}${currentUrl.pathname.replace(/\/[^\/]*$/, '')}`;
                const enlaceMontura = `${baseUrl}/?codigo=${montura.codigo}`;
                
                html += `
                    <div class="catalog-item">
                        <div class="item-info">
                            <div class="item-code">${iconoCategoria} ${montura.codigo} - ${montura.precio}</div>
                            <div class="item-details">${montura.nombre}</div>
                        </div>
                        <div class="item-actions">
                            <a href="${enlaceMontura}" target="_blank" class="action-btn btn-view">Ver</a>
                            <button onclick="eliminarMontura('${montura.codigo}')" class="action-btn btn-delete">Eliminar</button>
                        </div>
                    </div>
                `;
            });
            
            catalogList.innerHTML = html;
        }

        async function eliminarMontura(codigo) {
            if (confirm(`¬øEliminar montura ${codigo}?`)) {
                const monturas = await obtenerMonturas();
                delete monturas[codigo];
                await guardarMonturas(monturas);
                await cargarCatalogo();
                alert(`‚úÖ Montura ${codigo} eliminada`);
            }
        }

        function verCatalogo() {
            const currentUrl = new URL(window.location.href);
            const baseUrl = `${currentUrl.protocol}//${currentUrl.host}${currentUrl.pathname.replace(/\/[^\/]*$/, '')}`;
            window.open(`${baseUrl}/`, '_blank');
        }
    </script>
</body>
</html>
