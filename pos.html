<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Urbana Visión</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #1e293b; 
            min-height: 100vh; 
            color: white; 
            padding: 10px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #3b82f6;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tab-content.active { display: block; }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #10b981;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 13px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .list-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .list-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .list-item-title {
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .list-item-info {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .invoice-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .summary-total {
            font-weight: 800;
            font-size: 18px;
            color: #10b981;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
        }
        
        .cart-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        .cart-item-price {
            color: #10b981;
            font-size: 12px;
        }
        
        .cart-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qty-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        
        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .alert {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        /* NUEVOS ESTILOS PARA NCF */
        .ncf-config-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ncf-config-item.sin-comprobante {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .ncf-config-item.agotado {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .ncf-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .ncf-remaining {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        .ncf-remaining.ok {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .ncf-remaining.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .ncf-remaining.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💼 POS Urbana Visión</h1>
            <p>Sistema Punto de Venta Completo</p>
            <div style="margin-top: 10px;">
                <button onclick="goToMainSite()" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 8px 15px; border-radius: 10px; font-size: 12px; cursor: pointer; margin-right: 10px;">
                    🏠 Sitio Principal
                </button>
                <button onclick="goToAdmin()" style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 8px 15px; border-radius: 10px; font-size: 12px; cursor: pointer;">
                    ⚙️ Panel Admin
                </button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('clientes')">👥 Clientes</button>
            <button class="tab-btn" onclick="showTab('inventario')">📦 Inventario</button>
            <button class="tab-btn" onclick="showTab('comprobantes')">📋 NCF</button>
            <button class="tab-btn" onclick="showTab('facturacion')">💰 Facturar</button>
        </div>

        <div id="alertContainer"></div>

        <!-- TAB CLIENTES -->
        <div id="clientes" class="tab-content active">
            <h2 class="section-title">👥 Gestión de Clientes</h2>
            
            <form id="clienteForm">
                <div class="form-group">
                    <label class="form-label">📝 Nombre Completo</label>
                    <input type="text" id="clienteNombre" class="form-input" placeholder="Nombre del cliente">
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label class="form-label">📱 Teléfono</label>
                        <input type="tel" id="clienteTelefono" class="form-input" placeholder="809-000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">🆔 Cédula/RNC</label>
                        <input type="text" id="clienteCedula" class="form-input" placeholder="000-0000000-0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">📧 Correo Electrónico</label>
                    <input type="email" id="clienteCorreo" class="form-input" placeholder="cliente@email.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">🏠 Dirección</label>
                    <textarea id="clienteDireccion" class="form-textarea" rows="2" placeholder="Dirección completa"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">💬 Comentarios</label>
                    <textarea id="clienteComentarios" class="form-textarea" rows="2" placeholder="Observaciones adicionales"></textarea>
                </div>
                
                <button type="button" onclick="guardarCliente()" class="btn btn-primary">💾 Guardar Cliente</button>
                <button type="button" onclick="limpiarFormularioCliente()" class="btn btn-secondary">🗑️ Limpiar</button>
            </form>
            
            <h3 style="margin: 20px 0 10px 0; font-size: 16px;">📋 Lista de Clientes</h3>
            <div id="listaClientes">
                <div class="empty-state">
                    <div class="empty-icon">👥</div>
                    <div>No hay clientes registrados</div>
                </div>
            </div>
        </div>

        <!-- TAB INVENTARIO -->
        <div id="inventario" class="tab-content">
            <h2 class="section-title">📦 Gestión de Inventario</h2>
            
            <button onclick="sincronizarInventario()" class="btn btn-success">🔄 Sincronizar con Catálogo</button>
            
            <form id="productoForm" style="margin-top: 15px;">
                <div class="form-group">
                    <label class="form-label">🔤 ID Producto</label>
                    <input type="text" id="productoId" class="form-input" placeholder="H001" style="text-transform: uppercase;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">📝 Descripción</label>
                    <textarea id="productoDescripcion" class="form-textarea" rows="3" placeholder="Descripción detallada del producto"></textarea>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label class="form-label">💰 Precio Base</label>
                        <input type="number" id="productoPrecio" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">📊 Stock</label>
                        <input type="number" id="productoStock" class="form-input" placeholder="0" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">💬 Comentarios</label>
                    <textarea id="productoComentarios" class="form-textarea" rows="2" placeholder="Observaciones del producto"></textarea>
                </div>
                
                <button type="button" onclick="guardarProducto()" class="btn btn-primary">💾 Guardar Producto</button>
                <button type="button" onclick="limpiarFormularioProducto()" class="btn btn-secondary">🗑️ Limpiar</button>
            </form>
            
            <h3 style="margin: 20px 0 10px 0; font-size: 16px;">📋 Lista de Productos</h3>
            <div id="listaProductos">
                <div class="empty-state">
                    <div class="empty-icon">📦</div>
                    <div>No hay productos en inventario</div>
                </div>
            </div>
        </div>

        <!-- TAB COMPROBANTES NCF - CORREGIDO -->
        <div id="comprobantes" class="tab-content">
            <h2 class="section-title">📋 Comprobantes Fiscales (NCF)</h2>
            
            <button onclick="abrirConfiguracionNCF()" class="btn btn-warning">⚙️ Configurar Rangos DGII</button>
            
            <div id="listaComprobantes">
                <!-- NCF SIN COMPROBANTE -->
                <div class="ncf-config-item sin-comprobante">
                    <div class="list-item-title">🆓 Sin Comprobante Fiscal</div>
                    <div class="list-item-info">
                        Para clientes rurales, operaciones benéficas o casos especiales.<br>
                        <strong>Nota:</strong> No genera NCF en la factura.
                    </div>
                </div>

                <!-- NCF CONSUMIDOR FINAL -->
                <div class="ncf-config-item" id="ncf-consumidor">
                    <div class="list-item-title">🧾 Consumidor Final</div>
                    <div class="list-item-info">
                        Rango: <span id="rangoConsumidor">Sin configurar</span><br>
                        Siguiente: <span id="siguienteConsumidor">-</span>
                    </div>
                    <div class="ncf-status">
                        <span>Disponibles:</span>
                        <span class="ncf-remaining ok" id="remainingConsumidor">0</span>
                    </div>
                </div>
                
                <!-- NCF EMPRESARIAL -->
                <div class="ncf-config-item" id="ncf-empresarial">
                    <div class="list-item-title">🏢 Empresarial</div>
                    <div class="list-item-info">
                        Rango: <span id="rangoEmpresarial">Sin configurar</span><br>
                        Siguiente: <span id="siguienteEmpresarial">-</span>
                    </div>
                    <div class="ncf-status">
                        <span>Disponibles:</span>
                        <span class="ncf-remaining ok" id="remainingEmpresarial">0</span>
                    </div>
                </div>
                
                <!-- NCF GUBERNAMENTAL -->
                <div class="ncf-config-item" id="ncf-gubernamental">
                    <div class="list-item-title">🏛️ Gubernamental</div>
                    <div class="list-item-info">
                        Rango: <span id="rangoGubernamental">Sin configurar</span><br>
                        Siguiente: <span id="siguienteGubernamental">-</span>
                    </div>
                    <div class="ncf-status">
                        <span>Disponibles:</span>
                        <span class="ncf-remaining ok" id="remainingGubernamental">0</span>
                    </div>
                </div>
                
                <!-- NCF ZONA FRANCA -->
                <div class="ncf-config-item" id="ncf-zona_franca">
                    <div class="list-item-title">🆓 Zona Franca</div>
                    <div class="list-item-info">
                        Rango: <span id="rangoZonaFranca">Sin configurar</span><br>
                        Siguiente: <span id="siguienteZonaFranca">-</span>
                    </div>
                    <div class="ncf-status">
                        <span>Disponibles:</span>
                        <span class="ncf-remaining ok" id="remainingZonaFranca">0</span>
                    </div>
                </div>
            </div>
            
            <div class="row" style="margin-top: 20px;">
                <button onclick="resetearComprobantes()" class="btn btn-danger">🔄 Reset NCF</button>
                <button onclick="exportarNCF()" class="btn btn-secondary">📤 Exportar</button>
            </div>
        </div>

        <!-- TAB FACTURACIÓN - CORREGIDO -->
        <div id="facturacion" class="tab-content">
            <h2 class="section-title">💰 Facturación</h2>
            
            <div class="form-group">
                <label class="form-label">👤 Seleccionar Cliente</label>
                <select id="facturaCliente" class="form-select">
                    <option value="">Seleccione un cliente...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">📋 Tipo de Comprobante</label>
                <select id="facturaComprobante" class="form-select">
                    <option value="sin_comprobante">🆓 Sin Comprobante Fiscal</option>
                    <option value="consumidor">🧾 Consumidor Final</option>
                    <option value="empresarial">🏢 Empresarial</option>
                    <option value="gubernamental">🏛️ Gubernamental</option>
                    <option value="zona_franca">🆓 Zona Franca</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">💳 Forma de Pago</label>
                <select id="facturaFormaPago" class="form-select">
                    <option value="efectivo">💵 Efectivo</option>
                    <option value="tarjeta">💳 Tarjeta</option>
                    <option value="transferencia">🏦 Transferencia</option>
                    <option value="credito">📄 Crédito</option>
                </select>
            </div>
            
            <h3 style="margin: 20px 0 10px 0; font-size: 16px;">🛒 Agregar Productos</h3>
            <div class="row">
                <div class="form-group">
                    <select id="facturaProducto" class="form-select">
                        <option value="">Seleccione producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <button onclick="agregarProductoFactura()" class="btn btn-primary">➕ Agregar</button>
                </div>
            </div>
            
            <h3 style="margin: 20px 0 10px 0; font-size: 16px;">🛍️ Productos en Factura</h3>
            <div id="carritoFactura">
                <div class="empty-state">
                    <div class="empty-icon">🛒</div>
                    <div>No hay productos agregados</div>
                </div>
            </div>
            
            <div id="resumenFactura" class="invoice-summary" style="display: none;">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="facturaSubtotal">RD$0.00</span>
                </div>
                <div class="summary-row">
                    <span>ITBIS (18%):</span>
                    <span id="facturaItbis">RD$0.00</span>
                </div>
                <div class="summary-row summary-total">
                    <span>Total:</span>
                    <span id="facturaTotal">RD$0.00</span>
                </div>
            </div>
            
            <button onclick="procesarFactura()" class="btn btn-success" id="btnProcesarFactura" disabled>📄 Generar Factura PDF</button>
            <button onclick="limpiarFactura()" class="btn btn-secondary">🗑️ Limpiar Factura</button>
        </div>
    </div>

    <!-- MODAL CONFIGURACIÓN NCF -->
    <div id="modalConfigNCF" class="modal">
        <div class="modal-content">
            <div class="modal-header">⚙️ Configurar Rangos NCF - DGII</div>
            
            <div class="form-group">
                <label class="form-label">📋 Tipo de NCF</label>
                <select id="tipoNCFConfig" class="form-select">
                    <option value="consumidor">🧾 Consumidor Final (B01)</option>
                    <option value="empresarial">🏢 Empresarial (B02)</option>
                    <option value="gubernamental">🏛️ Gubernamental (B03)</option>
                    <option value="zona_franca">🆓 Zona Franca (B04)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">🔢 NCF Inicial (Asignado por DGII)</label>
                <input type="text" id="ncfInicial" class="form-input" placeholder="B01000000001" maxlength="13" style="text-transform: uppercase;">
            </div>
            
            <div class="form-group">
                <label class="form-label">🔢 NCF Final (Asignado por DGII)</label>
                <input type="text" id="ncfFinal" class="form-input" placeholder="B01000099999" maxlength="13" style="text-transform: uppercase;">
            </div>
            
            <div class="row">
                <button onclick="guardarConfigNCF()" class="btn btn-success">💾 Guardar</button>
                <button onclick="cerrarModalNCF()" class="btn btn-secondary">❌ Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // VARIABLES GLOBALES
        var WHATSAPP_NUMBER = '18097135307';
        var BASE_URL = window.location.origin + window.location.pathname.replace(/[^/]*$/, '');
        var currentTab = 'clientes';
        var carritoActual = [];
        var clienteSeleccionado = null;
        
        // ESTRUCTURA MEJORADA PARA NCF
        var defaultNCFConfig = {
            'consumidor': { inicial: '', final: '', actual: 0, prefijo: 'B01' },
            'empresarial': { inicial: '', final: '', actual: 0, prefijo: 'B02' },
            'gubernamental': { inicial: '', final: '', actual: 0, prefijo: 'B03' },
            'zona_franca': { inicial: '', final: '', actual: 0, prefijo: 'B04' }
        };
        
        // Gestión de pestañas
        function showTab(tabName) {
            var contents = document.querySelectorAll('.tab-content');
            var buttons = document.querySelectorAll('.tab-btn');
            
            contents.forEach(content => content.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            
            if (tabName === 'facturacion') {
                cargarClientesSelect();
                cargarProductosSelect();
            } else if (tabName === 'clientes') {
                cargarListaClientes();
            } else if (tabName === 'inventario') {
                cargarListaProductos();
            } else if (tabName === 'comprobantes') {
                actualizarVistaComprobantes();
            }
        }
        
        // Funciones de utilidad para almacenamiento
        function safeGetStorage(key) {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    var value = localStorage.getItem(key);
                    if (value && value !== 'null' && value !== 'undefined') {
                        return JSON.parse(value);
                    }
                }
            } catch (e) {
                console.log('Storage error:', e);
            }
            return {};
        }
        
        function safeSetStorage(key, value) {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                }
            } catch (e) {
                console.log('Storage error:', e);
                return false;
            }
        }
        
        function showAlert(message, type = 'success') {
            var alertHtml = '<div class="alert alert-' + type + '">' + message + '</div>';
            document.getElementById('alertContainer').innerHTML = alertHtml;
            
            setTimeout(function() {
                document.getElementById('alertContainer').innerHTML = '';
            }, 4000);
        }
        
        // GESTIÓN DE CLIENTES
        function guardarCliente() {
            var cliente = {
                id: Date.now().toString(),
                nombre: document.getElementById('clienteNombre').value.trim(),
                telefono: document.getElementById('clienteTelefono').value.trim(),
                cedula: document.getElementById('clienteCedula').value.trim(),
                correo: document.getElementById('clienteCorreo').value.trim(),
                direccion: document.getElementById('clienteDireccion').value.trim(),
                comentarios: document.getElementById('clienteComentarios').value.trim(),
                fechaRegistro: new Date().toISOString()
            };
            
            if (!cliente.nombre || !cliente.telefono) {
                showAlert('⚠️ Nombre y teléfono son obligatorios', 'error');
                return;
            }
            
            var clientes = safeGetStorage('urbana_clientes');
            clientes[cliente.id] = cliente;
            
            if (safeSetStorage('urbana_clientes', clientes)) {
                showAlert('✅ Cliente guardado exitosamente');
                limpiarFormularioCliente();
                cargarListaClientes();
            } else {
                showAlert('❌ Error al guardar cliente', 'error');
            }
        }
        
        function limpiarFormularioCliente() {
            document.getElementById('clienteForm').reset();
        }
        
        function cargarListaClientes() {
            var clientes = safeGetStorage('urbana_clientes');
            var container = document.getElementById('listaClientes');
            var keys = Object.keys(clientes);
            
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">👥</div><div>No hay clientes registrados</div></div>';
                return;
            }
            
            var html = '';
            keys.forEach(function(key) {
                var cliente = clientes[key];
                html += '<div class="list-item" onclick="editarCliente(\'' + key + '\')">';
                html += '<div class="list-item-title">' + cliente.nombre + '</div>';
                html += '<div class="list-item-info">📱 ' + cliente.telefono + ' | 🆔 ' + (cliente.cedula || 'Sin cédula') + '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function editarCliente(clienteId) {
            var clientes = safeGetStorage('urbana_clientes');
            var cliente = clientes[clienteId];
            
            if (cliente) {
                document.getElementById('clienteNombre').value = cliente.nombre || '';
                document.getElementById('clienteTelefono').value = cliente.telefono || '';
                document.getElementById('clienteCedula').value = cliente.cedula || '';
                document.getElementById('clienteCorreo').value = cliente.correo || '';
                document.getElementById('clienteDireccion').value = cliente.direccion || '';
                document.getElementById('clienteComentarios').value = cliente.comentarios || '';
            }
        }
        
        // GESTIÓN DE INVENTARIO
        function sincronizarInventario() {
            var monturas = safeGetStorage('urbana_monturas');
            var productos = safeGetStorage('urbana_productos');
            var monturaKeys = Object.keys(monturas);
            
            if (monturaKeys.length === 0) {
                showAlert('⚠️ No hay productos en el catálogo para sincronizar', 'error');
                return;
            }
            
            var sincronizados = 0;
            monturaKeys.forEach(function(key) {
                var montura = monturas[key];
                if (!productos[montura.codigo]) {
                    var precio = parseFloat(montura.precio.replace(/[^0-9.-]+/g,"")) || 0;
                    productos[montura.codigo] = {
                        id: montura.codigo,
                        descripcion: montura.nombre,
                        precioBase: precio,
                        stock: 1,
                        comentarios: 'Sincronizado desde catálogo',
                        fechaSync: new Date().toISOString()
                    };
                    sincronizados++;
                }
            });
            
            if (safeSetStorage('urbana_productos', productos)) {
                showAlert('✅ Sincronizados ' + sincronizados + ' productos del catálogo');
                cargarListaProductos();
            } else {
                showAlert('❌ Error al sincronizar inventario', 'error');
            }
        }
        
        function guardarProducto() {
            var producto = {
                id: document.getElementById('productoId').value.trim().toUpperCase(),
                descripcion: document.getElementById('productoDescripcion').value.trim(),
                precioBase: parseFloat(document.getElementById('productoPrecio').value) || 0,
                stock: parseInt(document.getElementById('productoStock').value) || 0,
                comentarios: document.getElementById('productoComentarios').value.trim(),
                fechaModificacion: new Date().toISOString()
            };
            
            if (!producto.id || !producto.descripcion || producto.precioBase <= 0) {
                showAlert('⚠️ Complete todos los campos obligatorios', 'error');
                return;
            }
            
            var productos = safeGetStorage('urbana_productos');
            productos[producto.id] = producto;
            
            if (safeSetStorage('urbana_productos', productos)) {
                showAlert('✅ Producto guardado: ' + producto.id);
                limpiarFormularioProducto();
                cargarListaProductos();
            } else {
                showAlert('❌ Error al guardar producto', 'error');
            }
        }
        
        function limpiarFormularioProducto() {
            document.getElementById('productoForm').reset();
        }
        
        function cargarListaProductos() {
            var productos = safeGetStorage('urbana_productos');
            var container = document.getElementById('listaProductos');
            var keys = Object.keys(productos);
            
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📦</div><div>No hay productos en inventario</div></div>';
                return;
            }
            
            var html = '';
            keys.forEach(function(key) {
                var producto = productos[key];
                html += '<div class="list-item">';
                html += '<div class="list-item-title">' + producto.id + '</div>';
                html += '<div class="list-item-info">' + producto.descripcion + '<br>💰 RD$' + producto.precioBase.toFixed(2) + ' | 📊 Stock: ' + producto.stock + '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        // GESTIÓN NUEVA DE NCF - CORREGIDA
        function abrirConfiguracionNCF() {
            document.getElementById('modalConfigNCF').style.display = 'flex';
        }
        
        function cerrarModalNCF() {
            document.getElementById('modalConfigNCF').style.display = 'none';
            document.getElementById('ncfInicial').value = '';
            document.getElementById('ncfFinal').value = '';
        }
        
        function guardarConfigNCF() {
            var tipo = document.getElementById('tipoNCFConfig').value;
            var inicial = document.getElementById('ncfInicial').value.trim().toUpperCase();
            var final = document.getElementById('ncfFinal').value.trim().toUpperCase();
            
            if (!inicial || !final) {
                showAlert('⚠️ Complete ambos rangos de NCF', 'error');
                return;
            }
            
            // Validar formato NCF
            var regex = /^B0[1-4]\d{10}$/;
            if (!regex.test(inicial) || !regex.test(final)) {
                showAlert('⚠️ Formato de NCF inválido. Debe ser B01/B02/B03/B04 + 10 dígitos', 'error');
                return;
            }
            
            // Validar que inicial sea menor que final
            var numInicial = parseInt(inicial.substr(3));
            var numFinal = parseInt(final.substr(3));
            
            if (numInicial >= numFinal) {
                showAlert('⚠️ El NCF inicial debe ser menor que el final', 'error');
                return;
            }
            
            var config = safeGetStorage('urbana_ncf_config') || defaultNCFConfig;
            config[tipo] = {
                inicial: inicial,
                final: final,
                actual: numInicial,
                prefijo: inicial.substr(0, 3)
            };
            
            if (safeSetStorage('urbana_ncf_config', config)) {
                showAlert('✅ Configuración NCF guardada para ' + tipo, 'success');
                cerrarModalNCF();
                actualizarVistaComprobantes();
            } else {
                showAlert('❌ Error al guardar configuración', 'error');
            }
        }
        
        function obtenerSiguienteNCF(tipo) {
            if (tipo === 'sin_comprobante') {
                return null; // No genera NCF
            }
            
            var config = safeGetStorage('urbana_ncf_config') || defaultNCFConfig;
            var tipoConfig = config[tipo];
            
            if (!tipoConfig || !tipoConfig.inicial || !tipoConfig.final) {
                throw new Error('NCF tipo ' + tipo + ' no configurado. Configure los rangos primero.');
            }
            
            var numFinal = parseInt(tipoConfig.final.substr(3));
            
            if (tipoConfig.actual > numFinal) {
                throw new Error('NCF agotados para tipo ' + tipo + '. Contacte a la DGII.');
            }
            
            var ncf = tipoConfig.prefijo + String(tipoConfig.actual).padStart(10, '0');
            
            // Incrementar para próximo uso
            tipoConfig.actual++;
            config[tipo] = tipoConfig;
            safeSetStorage('urbana_ncf_config', config);
            
            return ncf;
        }
        
        function calcularNCFDisponibles(tipo) {
            var config = safeGetStorage('urbana_ncf_config') || defaultNCFConfig;
            var tipoConfig = config[tipo];
            
            if (!tipoConfig || !tipoConfig.inicial || !tipoConfig.final) {
                return 0;
            }
            
            var numFinal = parseInt(tipoConfig.final.substr(3));
            return Math.max(0, numFinal - tipoConfig.actual + 1);
        }
        
        function actualizarVistaComprobantes() {
            var config = safeGetStorage('urbana_ncf_config') || defaultNCFConfig;
            
            var tipos = ['consumidor', 'empresarial', 'gubernamental', 'zona_franca'];
            
            tipos.forEach(function(tipo) {
                var tipoConfig = config[tipo];
                var disponibles = calcularNCFDisponibles(tipo);
                
                // Actualizar rango
                var rangoElement = document.getElementById('rango' + tipo.charAt(0).toUpperCase() + tipo.slice(1).replace('_', ''));
                if (rangoElement) {
                    if (tipoConfig && tipoConfig.inicial && tipoConfig.final) {
                        rangoElement.textContent = tipoConfig.inicial + ' - ' + tipoConfig.final;
                    } else {
                        rangoElement.textContent = 'Sin configurar';
                    }
                }
                
                // Actualizar siguiente
                var siguienteElement = document.getElementById('siguiente' + tipo.charAt(0).toUpperCase() + tipo.slice(1).replace('_', ''));
                if (siguienteElement) {
                    if (tipoConfig && tipoConfig.inicial && disponibles > 0) {
                        siguienteElement.textContent = tipoConfig.prefijo + String(tipoConfig.actual).padStart(10, '0');
                    } else {
                        siguienteElement.textContent = '-';
                    }
                }
                
                // Actualizar disponibles
                var remainingElement = document.getElementById('remaining' + tipo.charAt(0).toUpperCase() + tipo.slice(1).replace('_', ''));
                if (remainingElement) {
                    remainingElement.textContent = disponibles;
                    
                    // Cambiar color según disponibilidad
                    remainingElement.className = 'ncf-remaining ';
                    if (disponibles === 0) {
                        remainingElement.className += 'danger';
                    } else if (disponibles < 100) {
                        remainingElement.className += 'warning';
                    } else {
                        remainingElement.className += 'ok';
                    }
                }
                
                // Actualizar estado del contenedor
                var container = document.getElementById('ncf-' + tipo);
                if (container) {
                    container.className = 'ncf-config-item';
                    if (disponibles === 0) {
                        container.className += ' agotado';
                    }
                }
            });
        }
        
        function resetearComprobantes() {
            if (confirm('⚠️ ¿Está seguro de resetear TODA la configuración de NCF? Esta acción no se puede deshacer.')) {
                safeSetStorage('urbana_ncf_config', defaultNCFConfig);
                showAlert('✅ Configuración NCF reseteada', 'success');
                actualizarVistaComprobantes();
            }
        }
        
        function exportarNCF() {
            try {
                var config = safeGetStorage('urbana_ncf_config') || defaultNCFConfig;
                var data = {
                    configuracion_ncf: config,
                    exportado: new Date().toISOString(),
                    sistema: 'Urbana Visión POS'
                };
                
                var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'urbana_ncf_config_' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('✅ Configuración NCF exportada exitosamente', 'success');
            } catch (e) {
                console.error('Error exporting NCF:', e);
                showAlert('❌ Error al exportar configuración NCF', 'error');
            }
        }
        
        // GESTIÓN DE FACTURACIÓN - CORREGIDA
        function cargarClientesSelect() {
            var clientes = safeGetStorage('urbana_clientes');
            var select = document.getElementById('facturaCliente');
            var keys = Object.keys(clientes);
            
            var html = '<option value="">Seleccione un cliente...</option>';
            keys.forEach(function(key) {
                var cliente = clientes[key];
                html += '<option value="' + key + '">' + cliente.nombre + ' - ' + cliente.telefono + '</option>';
            });
            
            select.innerHTML = html;
        }
        
        function cargarProductosSelect() {
            var productos = safeGetStorage('urbana_productos');
            var select = document.getElementById('facturaProducto');
            var keys = Object.keys(productos);
            
            var html = '<option value="">Seleccione producto...</option>';
            keys.forEach(function(key) {
                var producto = productos[key];
                if (producto.stock > 0) {
                    html += '<option value="' + key + '">' + producto.id + ' - ' + producto.descripcion + ' (RD$' + producto.precioBase.toFixed(2) + ')</option>';
                }
            });
            
            select.innerHTML = html;
        }
        
        function agregarProductoFactura() {
            var productoId = document.getElementById('facturaProducto').value;
            if (!productoId) {
                showAlert('⚠️ Seleccione un producto', 'error');
                return;
            }
            
            var productos = safeGetStorage('urbana_productos');
            var producto = productos[productoId];
            
            var itemExistente = carritoActual.find(item => item.id === productoId);
            if (itemExistente) {
                itemExistente.cantidad++;
            } else {
                carritoActual.push({
                    id: productoId,
                    descripcion: producto.descripcion,
                    precio: producto.precioBase,
                    cantidad: 1
                });
            }
            
            actualizarCarritoFactura();
            document.getElementById('facturaProducto').value = '';
        }
        
        function actualizarCarritoFactura() {
            var container = document.getElementById('carritoFactura');
            
            if (carritoActual.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">🛒</div><div>No hay productos agregados</div></div>';
                document.getElementById('resumenFactura').style.display = 'none';
                document.getElementById('btnProcesarFactura').disabled = true;
                return;
            }
            
            var html = '';
            var subtotal = 0;
            
            carritoActual.forEach(function(item, index) {
                var total = item.precio * item.cantidad;
                subtotal += total;
                
                html += '<div class="cart-item">';
                html += '<div class="cart-item-info">';
                html += '<div class="cart-item-name">' + item.id + ' - ' + item.descripcion + '</div>';
                html += '<div class="cart-item-price">RD$' + item.precio.toFixed(2) + ' c/u</div>';
                html += '</div>';
                html += '<div class="cart-controls">';
                html += '<button class="qty-btn" onclick="cambiarCantidad(' + index + ', -1)">-</button>';
                html += '<div class="qty-display">' + item.cantidad + '</div>';
                html += '<button class="qty-btn" onclick="cambiarCantidad(' + index + ', 1)">+</button>';
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            
            var itbis = subtotal * 0.18;
            var total = subtotal + itbis;
            
            document.getElementById('facturaSubtotal').textContent = 'RD$' + subtotal.toFixed(2);
            document.getElementById('facturaItbis').textContent = 'RD$' + itbis.toFixed(2);
            document.getElementById('facturaTotal').textContent = 'RD$' + total.toFixed(2);
            document.getElementById('resumenFactura').style.display = 'block';
            document.getElementById('btnProcesarFactura').disabled = false;
        }
        
        function cambiarCantidad(index, cambio) {
            carritoActual[index].cantidad += cambio;
            if (carritoActual[index].cantidad <= 0) {
                carritoActual.splice(index, 1);
            }
            actualizarCarritoFactura();
        }
        
        function limpiarFactura() {
            carritoActual = [];
            document.getElementById('facturaCliente').value = '';
            document.getElementById('facturaComprobante').value = 'sin_comprobante';
            document.getElementById('facturaFormaPago').value = 'efectivo';
            actualizarCarritoFactura();
        }
        
        function procesarFactura() {
            var clienteId = document.getElementById('facturaCliente').value;
            var tipoComprobante = document.getElementById('facturaComprobante').value;
            var formaPago = document.getElementById('facturaFormaPago').value;
            
            if (!clienteId || carritoActual.length === 0) {
                showAlert('⚠️ Seleccione cliente y agregue productos', 'error');
                return;
            }
            
            var clientes = safeGetStorage('urbana_clientes');
            var cliente = clientes[clienteId];
            var numeroComprobante = null;
            
            try {
                if (tipoComprobante !== 'sin_comprobante') {
                    numeroComprobante = obtenerSiguienteNCF(tipoComprobante);
                }
            } catch (error) {
                showAlert('❌ ' + error.message, 'error');
                return;
            }
            
            var factura = {
                id: 'FACT-' + Date.now(),
                numeroComprobante: numeroComprobante,
                tipoComprobante: tipoComprobante,
                fecha: new Date().toLocaleDateString('es-DO'),
                cliente: cliente,
                productos: [...carritoActual],
                subtotal: carritoActual.reduce((sum, item) => sum + (item.precio * item.cantidad), 0),
                itbis: carritoActual.reduce((sum, item) => sum + (item.precio * item.cantidad), 0) * 0.18,
                total: carritoActual.reduce((sum, item) => sum + (item.precio * item.cantidad), 0) * 1.18,
                formaPago: formaPago
            };
            
            generarPDF(factura);
            
            var facturas = safeGetStorage('urbana_facturas');
            facturas[factura.id] = factura;
            safeSetStorage('urbana_facturas', facturas);
            
            var mensaje = numeroComprobante ? 
                '✅ Factura generada: ' + numeroComprobante : 
                '✅ Factura sin comprobante fiscal generada';
            showAlert(mensaje);
            
            limpiarFactura();
            actualizarVistaComprobantes(); // Actualizar disponibles
        }
        
        function generarPDF(factura) {
            try {
                var { jsPDF } = window.jspdf;
                var doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('URBANA VISIÓN', 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.text('Monturas de calidad premium', 105, 30, { align: 'center' });
                doc.text('Tel: 809-713-5307', 105, 40, { align: 'center' });
                
                // Información de factura
                doc.setFontSize(14);
                doc.text('FACTURA', 20, 60);
                doc.setFontSize(10);
                
                if (factura.numeroComprobante) {
                    doc.text('NCF: ' + factura.numeroComprobante, 20, 70);
                } else {
                    doc.text('Sin Comprobante Fiscal', 20, 70);
                }
                
                doc.text('Fecha: ' + factura.fecha, 20, 80);
                doc.text('Forma de Pago: ' + factura.formaPago.toUpperCase(), 20, 90);
                
                // Información del cliente
                doc.text('CLIENTE:', 20, 110);
                doc.text('Nombre: ' + factura.cliente.nombre, 20, 120);
                doc.text('Teléfono: ' + factura.cliente.telefono, 20, 130);
                if (factura.cliente.cedula) doc.text('Cédula/RNC: ' + factura.cliente.cedula, 20, 140);
                
                // Productos
                var startY = 160;
                doc.text('PRODUCTOS:', 20, startY);
                
                var currentY = startY + 15;
                factura.productos.forEach(function(producto) {
                    var linea = producto.id + ' - ' + producto.descripcion;
                    doc.text(linea, 20, currentY);
                    doc.text('Cant: ' + producto.cantidad, 20, currentY + 10);
                    doc.text('Precio: RD$' + producto.precio.toFixed(2), 100, currentY + 10);
                    doc.text('Total: RD$' + (producto.precio * producto.cantidad).toFixed(2), 150, currentY + 10);
                    currentY += 25;
                });
                
                // Totales
                currentY += 10;
                doc.text('Subtotal: RD$' + factura.subtotal.toFixed(2), 150, currentY);
                doc.text('ITBIS (18%): RD$' + factura.itbis.toFixed(2), 150, currentY + 10);
                doc.setFontSize(12);
                doc.text('TOTAL: RD$' + factura.total.toFixed(2), 150, currentY + 25);
                
                // Descargar PDF
                var fileName = factura.numeroComprobante ? 
                    'Factura_' + factura.numeroComprobante + '.pdf' : 
                    'Factura_SinNCF_' + Date.now() + '.pdf';
                doc.save(fileName);
                
                // Enviar por WhatsApp
                setTimeout(function() {
                    enviarFacturaPorWhatsApp(factura);
                }, 1000);
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                showAlert('❌ Error al generar PDF. Verifique su navegador.', 'error');
            }
        }
        
        function enviarFacturaPorWhatsApp(factura) {
            var mensaje = '📄 *FACTURA URBANA VISIÓN*\n\n';
            
            if (factura.numeroComprobante) {
                mensaje += '🧾 NCF: ' + factura.numeroComprobante + '\n';
            } else {
                mensaje += '🆓 Sin Comprobante Fiscal\n';
            }
            
            mensaje += '📅 Fecha: ' + factura.fecha + '\n';
            mensaje += '👤 Cliente: ' + factura.cliente.nombre + '\n\n';
            
            mensaje += '🛍️ *PRODUCTOS:*\n';
            factura.productos.forEach(function(producto) {
                mensaje += '• ' + producto.id + ' - ' + producto.descripcion + '\n';
                mensaje += '  Cantidad: ' + producto.cantidad + ' | Precio: RD$' + producto.precio.toFixed(2) + '\n';
            });
            
            mensaje += '\n💰 *TOTALES:*\n';
            mensaje += 'Subtotal: RD$' + factura.subtotal.toFixed(2) + '\n';
            mensaje += 'ITBIS (18%): RD$' + factura.itbis.toFixed(2) + '\n';
            mensaje += '*TOTAL: RD$' + factura.total.toFixed(2) + '*\n\n';
            
            mensaje += '\n¡Gracias por confiar en Urbana Visión! 👓✨';
            
            var whatsappUrl = 'https://wa.me/' + factura.cliente.telefono.replace(/[^0-9]/g, '') + '?text=' + encodeURIComponent(mensaje);
            window.open(whatsappUrl, '_blank');
        }
        
        // Navegación
        function goToMainSite() {
            window.location.href = BASE_URL;
        }

        function goToAdmin() {
            window.location.href = BASE_URL + 'admin.html';
        }
        
        // Inicialización
        function inicializarPOS() {
            cargarListaClientes();
            
            // Inicializar configuración NCF si no existe
            var config = safeGetStorage('urbana_ncf_config');
            if (!config || Object.keys(config).length === 0) {
                safeSetStorage('urbana_ncf_config', defaultNCFConfig);
            }
            
            actualizarVistaComprobantes();
        }
        
        // Inicializar cuando la página carga
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarPOS);
        } else {
            inicializarPOS();
        }
    </script>
</body>
</html>
